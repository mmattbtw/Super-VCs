# https://medium.com/swlh/how-to-deploy-your-application-to-digital-ocean-using-github-actions-and-save-up-on-ci-cd-costs-74b7315facc2
name: Build & Deploy
on:
    push:
        branches:
            - master
        paths:
            - '**.ts'
            - '.github/workflows/deploy.yml'
            - '**.prisma'
            - 'package.json'
            - 'pnpm-lock.yaml'
            - 'src/**'
            - 'prisma/**'
jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Deploy NodeJS app
              uses: appleboy/ssh-action@v0.1.2
              with:
                  host: ${{secrets.SSH_HOST}}
                  username: ${{ secrets.SSH_USERNAME }}
                  password: ${{ secrets.SSH_PASSWORD }}

                  script: |
                      cd ~/pingpong
                      git pull
                      /home/mmatt/.local/share/pnpm/pnpm i
                      /home/mmatt/.local/share/pnpm/pnpm prisma db push
                      /home/mmatt/.local/share/pnpm/pnpm prod
                      pm2 restart pingpong --update-env --watch
                      echo 'Deployment Complete'
